# Results

## Historical trends over past years

The line chart over below shows historical changes in newly approved license application volumes from 2017 to March 2021, aggregated to monthly frequency and mapped to five boroughs by zip codes. The shading represents the period since the onset of the pandemic. Across the five boroughs, the impact of the pandemic is clearly visible, with new applications dropping sharply around end-March in 2020. The troughs of this sharp drop was in April 2020 during the first lockdowns in spring. Afterwards, the volume of new licenses have improved steadily in the Bronx, Brooklyn, Manhattan and Queens. The volume in Stetan Island, however, did not show much improvement. Over the winter, NYC including Stetan Island saw substantial increases in newly approved licenses. 

```{r}
library(lubridate)
ny_license_monthly <- ny_license %>% mutate(months = as.Date(floor_date(start_date, "month"), format="%Y-%m-%d")) %>% 
    group_by(borough, months) %>% 
    summarize(count=n())

ny_license_monthly %>% ggplot(aes(x=months, y=count, color=borough)) +
    theme_bw() +
    theme(panel.grid.major = element_line(colour = "#D3D3D3")) +
    theme(panel.grid.minor = element_blank()) +
    geom_rect(xmin=as.Date("2020-03-01"), xmax=as.Date("2021-06-01"), 
            ymin=-Inf, ymax=Inf, fill="#F5F5F5", alpha=0.05, col = "#F5F5F5") +
    geom_line(size = 0.6 ) +
    labs(title = "Number of new license approved by NYC boroughs",
         x = "Years", y = "Count", color = "Borough") +
    scale_x_date(date_labels = "%Y")

```

```{r}
library(tidyverse)
ny_license %>% 
  filter(status == "Issued") %>%  
  group_by(borough) %>% 
  summarise(count=n()) %>% 
    ggplot(aes(x = reorder(borough, -count), y = count)) + 
    geom_bar(stat = 'identity') +
    labs(title = "Approved license applications by boroughs",
         x = "Regions", y = "Counts")
```

## Identifying seasonality in data

Plot of license applications
```{r message = FALSE}
month_year_lic = ny_license %>% 
  mutate(start_month=format(start_date, "%m"), 
         start_year=format(start_date, "%Y")) %>% 
  group_by(start_year, start_month) %>% 
  summarize(count=n())

ggplot(data = month_year_lic, 
            aes(x = start_month, y = count, 
                group = start_year, color = start_year)) + 
  geom_line() +
  labs(title = "Seasonal plot of license applications in each month",
       subtitle = "From 2017 to 2021")
```

Plot of operating business
```{r}
ny_business = ny_business %>% 
  mutate(license_creation_date = as.Date(license_creation_date),
         lic_expir_dd = as.Date(lic_expir_dd)) %>% 
  filter(license_creation_date <= lic_expir_dd) %>% # some weird data here, creation should be earlier than expiration
  drop_na(license_creation_date, lic_expir_dd)

b_indi = ny_business %>% filter(license_type=="Individual")
#head(b_indi)
b_busi = ny_business %>% filter(license_type=="Business")
#head(b_busi)
```


```{r}
mon_seq <- function(start, end){
  seq(start, end, by = "month")
}
countMonthActive = data.frame(format(do.call("c", mapply(mon_seq, 
                                      ny_business$license_creation_date, 
                                      ny_business$lic_expir_dd)), "%Y-%m") %>% table)
colnames(countMonthActive) = c("Date", "Count")
month_year_busi = countMonthActive %>% 
  mutate(Date = as.character(Date)) %>% 
  mutate(Date = paste0(Date, "-01")) %>% 
  mutate(Date = as.Date(Date)) %>% 
  filter(Date > as.Date('2017-01-01')) %>% 
  mutate(month=format(Date, "%m"), 
         year=format(Date, "%Y"))
#head(countMonthActive)
```

```{r}
ggplot(data = month_year_busi, 
            aes(x = month, y = Count, 
                group = year, color = year)) + 
  geom_line() +
  labs(title = "Seasonal plot of operating businesses in each month",
       subtitle = "From 2017 to 2021")
```


New application vs. renewal.

``` {r}
license %>% ggplot(aes(x=license_type, fill=application_or_renewal)) + geom_bar()
```


``` {r}
business %>% group_by(industry) %>% 
  summarize(count = n()) %>% 
  mutate(industry = fct_reorder(industry, count, .desc = FALSE)) %>% 
  ggplot(aes(y=industry, x=count)) + 
  geom_bar(stat = "identity")
```

``` {r}
ny_business %>% 
  ggplot(aes(x=license_type)) + 
  geom_bar(stat = "count")

ny_business %>% 
    ggplot(aes(x = address_city, y=..count.., fill=license_type)) + 
    stat_count(geom="bar") +
    labs(title = "Operating businesses by boroughs",
         x = "Regions", y = "Counts")
```
