# Results

## Searching for trends

The line chart below shows historical changes in newly approved license application volumes from 2017 to March 2021, aggregated to monthly frequency and mapped to five boroughs by zip codes. The shading represents the period since the onset of the pandemic. Across the five boroughs, the impact of the pandemic is clearly visible, with new applications dropping sharply around the end-March of 2020. The troughs of this sharp drop were in April 2020 during the first lockdowns in spring. Afterward, the volume of new licenses has improved steadily in the Bronx, Brooklyn, Manhattan, and Queens. The volume in Staten Island, however, did not show much improvement. Over the winter, NYC including Staten Island saw substantial increases in newly approved licenses.

```{r}
library(RColorBrewer)
library(lubridate)

boroughpal = brewer.pal(5, "Set1")

ny_license_monthly <- ny_license %>% mutate(months = as.Date(floor_date(start_date, "month"), format="%Y-%m-%d")) %>% 
    group_by(borough, months) %>% 
    summarize(count=n())

ny_license_monthly %>% ggplot(aes(x=months, y=count, color=borough)) +
    theme_bw() +
    theme(panel.grid.major = element_line(colour = "#D3D3D3")) +
    theme(panel.grid.minor = element_blank()) +
    geom_rect(xmin=as.Date("2020-03-01"), xmax=as.Date("2021-06-01"), 
            ymin=-Inf, ymax=Inf, fill="#F5F5F5", alpha=0.05, col = "#F5F5F5") +
    geom_line(size = 0.6 ) +
    labs(title = "Approved license applications by NYC boroughs",
         x = "Years", y = "Count", color = "Borough") +
    scale_x_date(date_labels = "%Y", date_breaks = "1 year") + 
    scale_color_manual(values = boroughpal,
                       limits = c("Brooklyn", "Queens", "Manhattan", "Bronx", "Staten_Island" ))
```

### New application vs. renewal

In the preceding chart, there are distinct jumps in applications close to end-2017 and end-2019. The two year gap between the two spikes of very similar magnitude suggests a cyclical factor driving this behavior. It turns out that most of these jumps are driven by a large flow of applications for renewals of special licenses such as home improvement contracting and sales businesses. According to the city [regulation]("https://www1.nyc.gov/site/dca/businesses/license-checklist-home-improvement-contractor.page"), home improvement contractors must renew their licenses every two years.

``` {r}
# ny_license %>% ggplot(aes(x=license_type, fill=application_or_renewal)) + geom_bar()
```

Excluding renewal applications, the damage of the pandemic on the local economy appears more starkly (see chart below). Applications for new business licenses dropped sharply and the recovery so far appears weak. Starting a new business takes a lot of resources and risk. Uncertain business outlook due to the ongoing pandemic probably discouraged many potential new businesses from entering the market. The shaded region in the chart denotes the period since the beginning of the pandemic in March 2020.

``` {r}
# Alternative
ny_license_monthly <- ny_license %>% filter(application_or_renewal == "Application") %>% 
    mutate(months = as.Date(floor_date(start_date, "month"), format="%Y-%m-%d")) %>% 
    group_by(borough, months) %>% 
    summarize(count=n())

ny_license_monthly %>% ggplot(aes(x=months, y=count, color=borough)) +
    theme_bw() +
    theme(panel.grid.major = element_line(colour = "#D3D3D3")) +
    theme(panel.grid.minor = element_blank()) +
    geom_rect(xmin=as.Date("2020-03-01"), xmax=as.Date("2021-06-01"), 
            ymin=-Inf, ymax=Inf, fill="#F5F5F5", alpha=0.05, col = "#F5F5F5") +
    geom_line(size = 0.6 ) +
    labs(title = "Approved license applications by NYC boroughs, excluding renewals",
         x = "Years", y = "Count", color = "Borough") +
    scale_x_date(date_labels = "%Y", date_breaks = "1 year") + 
    scale_color_manual(values = boroughpal,
                       limits = c("Brooklyn", "Queens", "Manhattan", "Bronx", "Staten_Island" ))
```

Moreover, the chart highlights the uneven recovery among the five boroughs. While Queens, Brooklyn, and Manhattan showed improvement over last summer and winter, the recovery in the Bronx and Staten Island lags other boroughs.

Note that the spike in authorized applications for new licenses close to the end of 2017 was due to a [change in city regulation](https://www1.nyc.gov/office-of-the-mayor/news/740-17/mayor-changes-laundry-license-application-requirements) governing licenses for laundry businesses, rather than a meaningful jump in demand for this business.

It is also noteworthy that large shares of applications for new licenses originate from outer-boroughs, which contradict a common perception that Manhattan is the business district of the city. The bar chart below shows that Brooklyn and Queens led approved applications for new licenses since 2016. Here, bars corresponding to boroughs are arranged in a descending order.

```{r}
library(tidyverse)
ny_license %>% 
  filter(application_or_renewal == "Application") %>% 
  filter(status == "Issued") %>%  
  group_by(borough) %>% 
  summarise(count=n()) %>% 
    ggplot(aes(x = reorder(borough, -count), y = count, fill = reorder(borough, count))) +
    # ggplot(aes(x = borough, y = count)) + 
    geom_bar(stat = 'identity') +
    theme_bw() +
    scale_fill_brewer(palette = "Blues") +
    labs(title = "Approved applications for new licenses by boroughs since 2016",
         x = "Boroughs", y = "Counts", fill = "Borough") +
    guides(fill = guide_legend(reverse = TRUE))

```

### Seasonality in data

Time series of business data often display seasonality. We first show the time series of applications for new licenses in all of NYC by year in one chart. The lines for 2020 and 2021 are substantially below the lines for other years, reflecting the impact of the pandemic. The data for November 2017 through April 2018 were affected by one-off change in license regulation, as discussed above. Overall, the chart below indicates new business application tends to rise in spring and gradually slows over the summer and winter.

```{r message = FALSE}
month_year_lic = ny_license %>% 
  filter(application_or_renewal == "Application") %>% 
  mutate(start_month=format(start_date, "%m"), 
         start_year=format(start_date, "%Y")) %>% 
  group_by(start_year, start_month) %>% 
  summarize(count=n())

ggplot(data = month_year_lic, 
            aes(x = start_month, y = count, 
                group = start_year, color = start_year)) + 
  geom_line() +
  labs(title = "Seasonal plot of license applications in each month",
       subtitle = "From 2017 to 2021", y = "Count", x = "Months")
```

Afterwards, we aggregate these lines together by month to summarize seasonal behavior by month. Below, we summarize the seasonal behavior of the data by month using a subset of the data between 2016 and 2019 as the pandemic brought a shift in trend in our data in 2020. This chart shows a seasonal pattern more succinctly. The median value for each month, represented by the horizontal line in each box, is a good proxy for the seasonal pattern of the data. High upper whiskers in April and November are due to distortions caused by policy changes in the period between November 2017 and April 2018.

``` {r}
temp <- ny_license %>% filter(application_or_renewal == "Application") %>% 
    mutate(months = as.Date(floor_date(start_date, "month"), format="%Y-%m-%d")) %>% 
    group_by(months) %>% summarise(applications = n()) %>% filter(months < as.Date("2020-01-01", format="%Y-%m-%d"))
ny_license_ts <- ts(temp$applications, frequency = 12, start = c(2016,1), end = c(2019,12))
boxplot(ny_license_ts ~ cycle(ny_license_ts), xlab = "Month", ylab = "Count", ann = TRUE)
```

``` {r, eval=FALSE}
library(xts)
temp <-  ny_license %>% filter(application_or_renewal == "Application") %>% 
    mutate(months = as.Date(floor_date(start_date, "month"), format="%Y-%m-%d")) %>% 
    group_by(months) %>% summarise(applications = n())
ny_license_xts <- xts(temp$applications, temp$months)
# Plot a sub-sample from 2016 to 2019
monthplot(ny_license_xts["2016/2019"], ylab = "Count by month", labels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))
```

### Scaling the impact

We calculate the "baseline" by borough by taking the median count of approved applications for new licenses by month between 2016 and 2019. For example, the sum of approved applications for new licenses by borough in March 2020 is compared to the median of the sums for March in respective years between 2016 and 2019. Using this methodology, we can estimate the impact of the pandemic while accounting for the seasonal distortions. The resulting metrics are scaled as percent change from the baseline.

``` {r}
# Calculate the baseline (pre-COVID)
precovid_license <- ny_license %>% 
    filter(application_or_renewal == "Application") %>% 
    mutate(months = as.Date(floor_date(start_date, "month"), format="%Y-%m-%d")) %>% 
    filter(months < as.Date("2020-01-01", format="%Y-%m-%d")) %>% 
    mutate(start_month=format(start_date, "%m"), 
           start_year=format(start_date, "%Y")) %>% 
    group_by(start_year, start_month, borough) %>% 
    # Get a table of sums of application by year, month and borough
    summarize(applications=n()) %>% 
    # Take the median by borough and month across years
    group_by(borough, start_month) %>% 
    summarise(med = median(applications)) 

# Post-COVID data
postcovid_license <- ny_license %>% 
    filter(application_or_renewal == "Application") %>% 
    mutate(months = as.Date(floor_date(start_date, "month"), format="%Y-%m-%d")) %>% 
    filter(months >=  as.Date("2020-01-01", format="%Y-%m-%d")) %>% 
    mutate(start_month=format(start_date, "%m"), 
           start_year=format(start_date, "%Y")) %>% 
    group_by(start_year, start_month, borough) %>% summarize(count=n())

postcovid_license <- postcovid_license %>%
    pivot_wider(id_cols = c(borough,start_month), names_from = start_year, values_from = count) %>% 
    arrange(borough)
colnames(postcovid_license)[3:4] <- c("y2020", "y2021")

# Combine the two dataframes
combined <- inner_join(precovid_license, postcovid_license, by=c("borough", "start_month"))
combined <- combined %>% mutate(pc2020 = y2020/med*100-100, pc2021 = y2021/med*100-100)

# The impact is calculated here and saved in a long data format
impact <- combined %>% 
    select(borough, start_month, pc2020, pc2021) %>%
    pivot_longer(cols = starts_with("pc"), names_to = "year", values_to = "impact" ) %>%
    arrange(borough, year) %>% 
    mutate(months = as.Date(paste(gsub("pc", "", year), start_month, "01", sep="-" ), format="%Y-%m-%d") )

impact %>% filter(months < as.Date("2021-04-01", format = "%Y-%m-%d")) %>% 
    ggplot(aes(x=months, y=impact, color=borough)) +
    geom_line(size = 0.6 ) +
    labs(title = "Impact of pandemic on the approved license applications by NYC boroughs",
         x = "", y = "Change from baseline (%)", color = "Borough") +
    scale_x_date(date_labels = "%b-%y", date_breaks = "3 month") +
    scale_color_manual(values = boroughpal,
                       limits = c("Brooklyn", "Queens", "Manhattan", "Bronx", "Staten_Island" ))
```

The chart above highlights a substantial drop in newly approved licenses during the spring lockdown in 2020. While these measures have improved since then, they remain at a very low level across the five boroughs, suggesting a long road to recovery for NYC.

Plot of operating business
```{r}
ny_business = ny_business %>% 
  mutate(license_creation_date = as.Date(license_creation_date),
         lic_expir_dd = as.Date(lic_expir_dd)) %>% 
  filter(license_creation_date <= lic_expir_dd) %>% # some weird data here, creation should be earlier than expiration
  drop_na(license_creation_date, lic_expir_dd)

b_indi = ny_business %>% filter(license_type=="Individual")
#head(b_indi)
b_busi = ny_business %>% filter(license_type=="Business")
#head(b_busi)
```


```{r}
mon_seq <- function(start, end){
  seq(start, end, by = "month")
}
countMonthActive = data.frame(format(do.call("c", mapply(mon_seq, 
                                      ny_business$license_creation_date, 
                                      ny_business$lic_expir_dd)), "%Y-%m") %>% table)
colnames(countMonthActive) = c("Date", "Count")
month_year_busi = countMonthActive %>% 
  mutate(Date = as.character(Date)) %>% 
  mutate(Date = paste0(Date, "-01")) %>% 
  mutate(Date = as.Date(Date)) %>% 
  filter(Date > as.Date('2017-01-01')) %>% 
  mutate(month=format(Date, "%m"), 
         year=format(Date, "%Y"))
#head(countMonthActive)
```

```{r}
ggplot(data = month_year_busi, 
            aes(x = month, y = Count, 
                group = year, color = year)) + 
  geom_line() +
  labs(title = "Seasonal plot of operating businesses in each month",
       subtitle = "From 2017 to 2021")
```



``` {r}
business %>% group_by(industry) %>% 
  summarize(count = n()) %>% 
  mutate(industry = fct_reorder(industry, count, .desc = FALSE)) %>% 
  ggplot(aes(y=industry, x=count)) + 
  geom_bar(stat = "identity")
```

``` {r}
ny_business %>% 
  ggplot(aes(x=license_type)) + 
  geom_bar(stat = "count")

ny_business %>% 
    ggplot(aes(x = address_city, y=..count.., fill=license_type)) + 
    stat_count(geom="bar") +
    labs(title = "Operating businesses by boroughs",
         x = "Regions", y = "Counts")
```
